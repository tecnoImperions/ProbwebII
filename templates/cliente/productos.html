{% extends 'cliente/base.html' %}
{% block title %}Productos{% endblock %}

{% block content %}

{% set lista = disponible if disponible is defined else productos %}

<style>
/* ================= ESTILOS RESPONSIVE ================= */
.productos-header{
  margin-bottom:16px;
}
.productos-header h5{
  font-size:1.4rem;
  font-weight:700;
  margin:0;
}
.productos-header p{
  font-size:.85rem;
  color:#64748b;
  margin:4px 0 0 0;
}

.search-filter-bar{
  background:#fff;
  padding:12px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
  margin-bottom:16px;
}
.search-box{
  position:relative;
  width:100%;
}
.search-box input{
  width:100%;
  height:44px;
  padding-left:42px;
  padding-right:12px;
  border-radius:10px;
  border:2px solid #e2e8f0;
  font-size:.9rem;
  transition:border-color 0.2s ease;
}
.search-box input:focus{
  outline:none;
  border-color:#3b82f6;
}
.search-box i{
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  color:#64748b;
  pointer-events:none;
}

.productos-grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:12px;
  margin-bottom:20px;
}

.producto-item{
  display:flex;
  height:100%;
}

.producto-card{
  background:#fff;
  border-radius:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  transition:transform 0.2s ease, box-shadow 0.2s ease;
  width:100%;
  height:100%;
  cursor:pointer;
}

.producto-card:active{
  transform:scale(0.98);
}

.producto-img-container{
  height:140px;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#f1f5f9;
  overflow:hidden;
  position:relative;
}

.producto-img-container img{
  width:100%;
  height:100%;
  object-fit:contain;
  object-position:center;
}

.producto-img-container i{
  font-size:3rem;
  color:#cbd5e1;
}

.producto-content{
  padding:12px;
  display:flex;
  flex-direction:column;
  flex:1;
}

.producto-nombre{
  font-size:.9rem;
  font-weight:600;
  color:#1e293b;
  margin-bottom:4px;
  line-height:1.3;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  min-height:2.4em;
}

.producto-descripcion{
  font-size:.75rem;
  color:#64748b;
  margin-bottom:8px;
  line-height:1.4;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  flex:1;
}

.producto-precio{
  font-size:1.2rem;
  font-weight:700;
  color:#10b981;
  margin:8px 0;
}

.empty-state{
  text-align:center;
  padding:60px 20px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}

.empty-state i{
  font-size:4rem;
  color:#cbd5e1;
  margin-bottom:16px;
}

.empty-state p{
  font-size:.95rem;
  color:#64748b;
  margin:0;
}

/* ================= MODAL DESDE ABAJO ================= */
.modal-overlay{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.5);
  z-index:2000;
  opacity:0;
  visibility:hidden;
  transition:all 0.3s ease;
}

.modal-overlay.active{
  opacity:1;
  visibility:visible;
}

.modal-sheet{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  max-height:85vh;
  background:#fff;
  border-radius:24px 24px 0 0;
  z-index:2001;
  transform:translateY(100%);
  transition:transform 0.3s ease;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.modal-sheet.active{
  transform:translateY(0);
}

.modal-handle{
  width:40px;
  height:4px;
  background:#cbd5e1;
  border-radius:2px;
  margin:12px auto 8px;
}

.modal-header{
  padding:0 20px 16px;
  border-bottom:1px solid #e2e8f0;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.modal-close{
  width:32px;
  height:32px;
  border-radius:50%;
  background:#f1f5f9;
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  color:#64748b;
  font-size:1.2rem;
  transition:background 0.2s;
}

.modal-close:active{
  background:#e2e8f0;
}

.modal-body{
  overflow-y:auto;
  flex:1;
}

.modal-img-container{
  width:100%;
  height:280px;
  background:#f1f5f9;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.modal-img-container img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
}

.modal-img-container i{
  font-size:5rem;
  color:#cbd5e1;
}

.modal-info{
  padding:20px;
}

.modal-nombre{
  font-size:1.5rem;
  font-weight:700;
  color:#1e293b;
  margin-bottom:8px;
  line-height:1.3;
}

.modal-precio{
  font-size:2rem;
  font-weight:700;
  color:#10b981;
  margin-bottom:16px;
}

.modal-section{
  margin-bottom:20px;
}

.modal-section-title{
  font-size:.85rem;
  font-weight:600;
  color:#64748b;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:8px;
}

.modal-descripcion{
  font-size:.95rem;
  color:#475569;
  line-height:1.6;
}

.modal-specs{
  background:#f8fafc;
  border-radius:12px;
  padding:16px;
}

.spec-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 0;
  border-bottom:1px solid #e2e8f0;
}

.spec-item:last-child{
  border-bottom:none;
}

.spec-icon{
  width:40px;
  height:40px;
  border-radius:10px;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#3b82f6;
  font-size:1.2rem;
}

.spec-content{
  flex:1;
}

.spec-label{
  font-size:.75rem;
  color:#64748b;
  margin-bottom:2px;
}

.spec-value{
  font-size:.9rem;
  font-weight:600;
  color:#1e293b;
}

.modal-footer{
  padding:16px 20px;
  background:#fff;
  border-top:1px solid #e2e8f0;
}

.btn-agregar-modal{
  width:100%;
  height:54px;
  border:none;
  background:linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  color:#fff;
  border-radius:12px;
  font-weight:700;
  font-size:1rem;
  cursor:pointer;
  transition:all 0.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  box-shadow:0 4px 12px rgba(30,64,175,0.3);
}

.btn-agregar-modal:active{
  transform:scale(0.98);
}

.btn-agregar-modal i{
  font-size:1.3rem;
}

/* ================= RESPONSIVE ================= */

@media (min-width: 768px) {
  .modal-sheet{
    left:50%;
    right:auto;
    max-width:430px;
    transform:translate(-50%, 100%);
  }
  
  .modal-sheet.active{
    transform:translate(-50%, 0);
  }
  
  .productos-header h5{
    font-size:1.5rem;
  }
  
  .search-filter-bar{
    padding:14px;
  }
  
  .search-box input{
    height:46px;
    font-size:.95rem;
  }
  
  .productos-grid{
    grid-template-columns:repeat(2, 1fr);
    gap:16px;
  }
  
  .producto-img-container{
    height:170px;
  }
  
  .producto-content{
    padding:14px;
  }
  
  .producto-nombre{
    font-size:1rem;
  }
  
  .producto-descripcion{
    font-size:.85rem;
  }
}

@media (max-width: 360px) {
  .productos-grid{
    gap:10px;
  }
  
  .producto-img-container{
    height:120px;
  }
  
  .producto-content{
    padding:10px;
  }
  
  .producto-nombre{
    font-size:.85rem;
  }
  
  .producto-descripcion{
    font-size:.7rem;
  }
  
  .producto-precio{
    font-size:1.1rem;
  }
}
</style>

<!-- HEADER -->
<div class="productos-header">
  <h5>Productos disponibles</h5>
  <p>Explora y agrega al carrito</p>
</div>

<!-- BUSCADOR -->
<div class="search-filter-bar">
  <div class="search-box">
    <i class="bi bi-search"></i>
    <input type="text" 
           id="searchInput"
           placeholder="Buscar producto..."
           onkeyup="filtrarProductos()"
           autocomplete="off">
  </div>
</div>

{% if lista and lista|length > 0 %}

<div class="productos-grid" id="productosList">
  {% for producto in lista %}
  <div class="producto-item"
       data-nombre="{{ producto.nombre|lower }}"
       data-descripcion="{{ producto.descripcion|lower if producto.descripcion else '' }}">

    <div class="producto-card" onclick="abrirModal({{ producto.id|int }})">

      <!-- IMAGEN -->
      <div class="producto-img-container">
        {% if producto.imagen %}
          <img src="{{ producto.imagen }}" 
               alt="{{ producto.nombre }}"
               loading="lazy">
        {% else %}
          <i class="bi bi-box-seam"></i>
        {% endif %}
      </div>

      <!-- INFO -->
      <div class="producto-content">
        <div class="producto-nombre">{{ producto.nombre }}</div>

        {% if producto.descripcion %}
        <div class="producto-descripcion">
          {{ producto.descripcion }}
        </div>
        {% endif %}

        {% if producto.precio %}
        <div class="producto-precio">
          Bs {{ "%.2f"|format(producto.precio) }}
        </div>
        {% endif %}
      </div>

    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<!-- VACÍO -->
<div class="empty-state">
  <i class="bi bi-inbox"></i>
  <p>No hay productos disponibles</p>
</div>
{% endif %}

<!-- MODAL PRODUCTO -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal()"></div>

<div class="modal-sheet" id="modalSheet">
  <div class="modal-handle"></div>
  
  <div class="modal-header">
    <h6 style="margin:0;font-weight:700;color:#1e293b;">Detalles del producto</h6>
    <button class="modal-close" onclick="cerrarModal()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  
  <div class="modal-body">
    <div class="modal-img-container" id="modalImagen">
      <i class="bi bi-box-seam"></i>
    </div>
    
    <div class="modal-info">
      <h3 class="modal-nombre" id="modalNombre">Producto</h3>
      <div class="modal-precio" id="modalPrecio">Bs 0.00</div>
      
      <div class="modal-section">
        <div class="modal-section-title">Descripción</div>
        <div class="modal-descripcion" id="modalDescripcion">
          Sin descripción disponible
        </div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">Información</div>
        <div class="modal-specs">
          <div class="spec-item">
            <div class="spec-icon">
              <i class="bi bi-tag-fill"></i>
            </div>
            <div class="spec-content">
              <div class="spec-label">Precio unitario</div>
              <div class="spec-value" id="modalPrecioInfo">Bs 0.00</div>
            </div>
          </div>
          
          <div class="spec-item">
            <div class="spec-icon">
              <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="spec-content">
              <div class="spec-label">Disponibilidad</div>
              <div class="spec-value" style="color:#10b981;">Disponible</div>
            </div>
          </div>
          
          <div class="spec-item">
            <div class="spec-icon">
              <i class="bi bi-truck"></i>
            </div>
            <div class="spec-content">
              <div class="spec-label">Entrega</div>
              <div class="spec-value">Disponible para pedido</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <button class="btn-agregar-modal" id="btnAgregarModal" onclick="agregarDesdeModal()">
      <i class="bi bi-cart-plus-fill"></i>
      <span>Agregar al carrito</span>
    </button>
  </div>
</div>

<script>
// Datos de productos para el modal
const productosData = {
  {% for producto in lista %}
  {{ producto.id|int }}: {
    id: {{ producto.id|int }},
    nombre: "{{ producto.nombre|safe }}",
    descripcion: "{{ producto.descripcion|safe if producto.descripcion else 'Sin descripción disponible' }}",
    precio: {{ producto.precio if producto.precio else 0 }},
    imagen: "{{ producto.imagen if producto.imagen else '' }}"
  }{% if not loop.last %},{% endif %}
  {% endfor %}
};

let productoSeleccionado = null;

function abrirModal(id){
  const producto = productosData[id];
  if(!producto) return;
  
  productoSeleccionado = id;
  
  // Actualizar contenido del modal
  document.getElementById('modalNombre').textContent = producto.nombre;
  document.getElementById('modalPrecio').textContent = 'Bs ' + producto.precio.toFixed(2);
  document.getElementById('modalPrecioInfo').textContent = 'Bs ' + producto.precio.toFixed(2);
  document.getElementById('modalDescripcion').textContent = producto.descripcion;
  
  // Actualizar imagen
  const imgContainer = document.getElementById('modalImagen');
  if(producto.imagen){
    imgContainer.innerHTML = `<img src="${producto.imagen}" alt="${producto.nombre}">`;
  } else {
    imgContainer.innerHTML = '<i class="bi bi-box-seam"></i>';
  }
  
  // Mostrar modal
  document.getElementById('modalOverlay').classList.add('active');
  document.getElementById('modalSheet').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function cerrarModal(){
  document.getElementById('modalOverlay').classList.remove('active');
  document.getElementById('modalSheet').classList.remove('active');
  document.body.style.overflow = '';
  productoSeleccionado = null;
}

function agregarDesdeModal(){
  if(!productoSeleccionado) return;
  
  const btn = document.getElementById('btnAgregarModal');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Agregando...</span>';

  fetch("{{ url_for('cliente_agregar_carrito') }}", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({producto_id: productoSeleccionado})
  })
  .then(r => r.json())
  .then(d => {
    if(d.success){
      btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span>¡Agregado al carrito!</span>';
      btn.style.background = '#10b981';
      
      setTimeout(() => {
        cerrarModal();
        btn.innerHTML = originalText;
        btn.style.background = '';
        btn.disabled = false;
      }, 1500);
    } else {
      alert(d.message || 'Error al agregar producto');
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  })
  .catch(err => {
    console.error('Error:', err);
    alert('Error de conexión');
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

function filtrarProductos(){
  const texto = document.getElementById('searchInput').value.toLowerCase().trim();
  const items = document.querySelectorAll('.producto-item');

  items.forEach(item => {
    const nombre = item.dataset.nombre || '';
    const descripcion = item.dataset.descripcion || '';
    const contenido = nombre + ' ' + descripcion;
    
    if(contenido.includes(texto)){
      item.style.display = '';
    } else {
      item.style.display = 'none';
    }
  });
}

// Cerrar modal con tecla ESC
document.addEventListener('keydown', function(e){
  if(e.key === 'Escape'){
    cerrarModal();
  }
});

// Prevenir scroll del body cuando el modal está abierto
document.getElementById('modalSheet').addEventListener('touchmove', function(e){
  e.stopPropagation();
});
</script>

{% endblock %}